<template>
<div class="page" id="gameSettingsPage">
	<hat-header @go-back="$router.go(-1)"></hat-header>
	<div class="content-small">
		<div id="gameSettingsPage_header">
			<h1 id="gameSettingsPage_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h1>
			<h2
				v-if="!$store.getters.isHost"
				id="gameSettingsPage_subtitle">
					–¢—ã –±–æ–ª—å—à–µ –Ω–µ —Ö–æ—Å—Ç. –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
			</h2>
		</div>
		<div id="gameSettingsPage_body">
			<div id="gameSettingsPage_layers">
				<div class="layer">
					<div class="label">
						–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —à–ª—è–ø–µ
						<span
							:class="{active: hints.wordNumber}"
							@click="showHint('wordNumber')"
							class="info"
							id="gameSettingsPage_wordNumberInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–ö–æ–≥–¥–∞ —Å–ª–æ–≤–∞ –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è, –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –∏ –∏–≥—Ä–∞.
						</div>
					</div>
					<input
						v-filter="settings.wordNumber"
						class="small-underlined-input input"
						id="gameSettingsPage_wordNumberField"
					>
				</div>
				<div class="layer" id="gameSettingsPage_delayTime">
					<div class="label">
						–í—Ä–µ–º—è –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É
						<span
							:class="{active: hints.delayTime}"
							@click="showHint('delayTime')"
							class="info"
							id="gameSettingsPage_delayTimeInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–í—Ä–µ–º—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞ –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞.
						</div>
					</div>
					<input
						v-filter.number="settings.delayTime"
						class="small-underlined-input input"
						id="gameSettingsPage_delayTimeField">
				</div>
				<div class="layer" id="gameSettingsPage_explanationTime">
					<div class="label">
						–í—Ä–µ–º—è –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
						<span
							:class="{active: hints.explanationTime}"
							@click="showHint('explanationTime')"
							class="info" id="gameSettingsPage_explanationTimeInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ª—é–±–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–æ.
						</div>
					</div>
					<input
						v-filter.number="settings.explanationTime"
						class="small-underlined-input input"
						id="gameSettingsPage_explanationTimeField">
				</div>
				<div class="layer" id="gameSettingsPage_aftermathTime">
					<div class="label">
						–í—Ä–µ–º—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ø—ã—Ç–∫—É
						<span
							:class="{active: hints.aftermathTime}"
							@click="showHint('aftermathTime')"
							class="info" id="gameSettingsPage_aftermathTimeInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–í —Ç–µ—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≥–∞–¥—ã–≤–∞—é—â–∏–π –º–æ–∂–µ—Ç –æ–∑–≤—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é.
						</div>
					</div>
					<input
						v-filter.number="settings.aftermathTime"
						class="small-underlined-input input"
						id="gameSettingsPage_aftermathTimeField">
				</div>
				<div class="layer" id="gameSettingsPage_dictionarySelection">
					<div class="label" id="gameSettingsPage_dictionarySelectionLabel">
						–°–ª–æ–≤–∞—Ä—å
						<span
							:class="{active: hints.dictionaryId}"
							@click="showHint('dictionaryId')"
							class="info"
							id="gameSettingsPage_dictionarySelectionInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–°–ª–æ–≤–∞—Ä—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–±–æ—Ä —Å–ª–æ–≤, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç –≤—ã–±—Ä–∞–Ω—ã —Å–ª–æ–≤–∞ –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏.
						</div>
					</div>
					<select
						v-model="settings.dictionaryId"
						class="medium-select"
						id="gameSettingsPage_dictionaryList">
						<option :value="0">–†—É—Å—Å–∫–∏–π (20000 —Å–ª–æ–≤)</option>
						<option :value="1">English (10000 words)</option>
					</select>
				</div>
				<div class="layer" id="gameSettingsPage_strictMode">
					<input
						v-model="settings.strictMode"
						type="checkbox"
						id="gameSettingsPage_strictModeCheckbox">
					<label for="gameSettingsPage_strictModeCheckbox"><span><check-svg/></span></label>
					<label>
						–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º
						<span
							:class="{active: hints.strictMode}"
							@click="showHint('strictMode')"
							class="info"
							id="gameSettingsPage_strictModeInfo">
							<span><info-svg/></span>
							<div class="arrow"></div>
						</span>
						<div class="popup-hint">
							–†–µ–∂–∏–º –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —à–ª—è–ø–Ω–∏–∫–æ–≤ üòä. –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—É–Ω–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ—É–≥–∞–¥–∞–Ω–Ω—ã–º.
						</div>
					</label>
				</div>
			</div>
			<div id="gameSettingsPage_actions">
				<button
					@click="applySettings"
					class="medium-button bg-green"
					id="gameSettingsPage_applyButton">
					–ü—Ä–∏–º–µ–Ω–∏—Ç—å
				</button><!--
			 --><button
			 		@click="cancelSettings"
			 		class="medium-button bg-blue"
					id="gameSettingsPage_revertButton">
					–û—Ç–º–µ–Ω–∞
				</button>
			</div>
		</div>
	</div>
</div>
</template>

<script>
import hatHeader from "_/hatHeader.vue"
import store from "__/store.js"
import router from "__/router"
import app from "__/app.js"
import infoSvg from "__/assets/svg/info.svg"
import checkSvg from "__/assets/svg/check.svg"

function number(value, {caretPosition}) {
	caretPosition = value.slice(0, caretPosition).replace(/\D+/g,"").length;
	value = parseInt(value.replace(/\D+/g,""));
	value = isNaN(value) ? null : value;
	return {value, caretPosition}
}
function max(maxValue) {
	return function(value) {
		return Math.min(value, maxValue)
	}
}

export default {
	data: function() {
		return {
			settings: {
				...this.$store.state.room.settings,
				delayTime: this.$store.state.room.settings.delayTime / 1000,
				explanationTime: this.$store.state.room.settings.explanationTime / 1000,
				aftermathTime: this.$store.state.room.settings.aftermathTime / 1000
			},
			hints: {
				wordNumber: false,
				delayTime: false,
				explanationTime: false,
				aftermathTime: false,
				dictionaryId: false,
				strictMode: false
			}
		}
	},
	methods: {
		showHint(hintName) {
			if (this.hints[hintName]) return
			this.hints[hintName] = true;
			let counter = 0;
			let listener = window.addEventListener("click", () => {
				if (counter == 1) {
					this.hints[hintName] = false;
					document.removeEventListener("click", listener)
				}
				counter++;
			});
		},
		applySettings() {
			app.applySettings({
				...this.settings,
				delayTime: this.settings.delayTime * 1000,
				explanationTime: this.settings.explanationTime * 1000,
				aftermathTime: this.settings.aftermathTime * 1000
			})
			this.$router.go(-1);
		},
		cancelSettings() {
			this.$router.go(-1);
		}
	},
	filtrations: {
		"settings.wordNumber": {
			number, max: {filter: max(999), when: "blur"}
		},
		"settings.delayTime": {
			number, max: {filter: max(99), when: "blur"}
		},
		"settings.aftermathTime": {
			number, max: {filter: max(99), when: "blur"}
		},
		"settings.explanationTime": {
			number, max: {filter: max(999), when: "blur"}
		}
	},
	components: {hatHeader, infoSvg, checkSvg},
	beforeRouteEnter: function(to, from, next) {
		if (store.state.room.connection != "online") {
			router.replace({path: "/join", query: {k: store.state.room.key, ...to.query}});
		} else {
			if (to.query.k != store.state.room.key) {
				next(vm => {
					vm.$router.replace({query: {k: store.state.room.key}})
				})
			}
		}
		next();
	},
}
</script>
